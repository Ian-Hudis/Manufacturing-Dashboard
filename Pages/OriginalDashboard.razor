@page "/OriginalDashboard"

@using MTConnectDashboard
@inject MSR1_Service productService

<style>
    body {
         background-color: rgb(240,255,250);
    }
    .rz-grid-table td {
        padding:0!important;
    }
</style>

<PageTitle>Main Page</PageTitle>
<div style="margin-left:5px; text-align:center;">
    @{#pragma warning disable CS8974}
@if(msr1_column == null)
{
        <p>Loading...</p>
}
else
{
        <RadzenGrid AllowFiltering="false" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" style="justify-content: right; border: 1px solid #9999ff; background-color: #F0FFFA; display: inline-block; margin-top: 5px;"
                    rowRender="@RowRender" cellRender="@CellRender" Density="@Density" HeaderCellRender="@HeaderFooterCellRender" FooterCellRender="@HeaderFooterCellRender"
             PageSize="17" AllowSorting="true" Data="@msr1_column" TItem="MSR1_column" ColumnWidth="90px" mnColumnWidth="150px" AllowColumnResize="true" AllowPaging="true">
                  <Columns>
                        <RadzenGridColumn TItem="MSR1_column" Property="MachineID" Title="Location" Width="110px"></RadzenGridColumn>
                        <RadzenGridColumn TItem="MSR1_column" Property="ProductionMonitorState" Title="WC State" Width="90px"> </RadzenGridColumn>
                        <RadzenGridColumn TItem="MSR1_column" Property="TimeInState" Title="MTC State Time" Width="80px"></RadzenGridColumn>
                        <RadzenGridColumn TItem="MSR1_column" Property="DisplayPartCount" Title="PartCount" Width="74px"></RadzenGridColumn>
                        <RadzenGridColumn TItem="MSR1_column" Property="PartCountTotal" Title="SAP_QTY" Width="60px"></RadzenGridColumn>
                        
                        <RadzenGridColumn TItem="MSR1_column" Property="Cycletime" Title="CycleTime" Width="60px"></RadzenGridColumn>
                        <RadzenGridColumn TItem="MSR1_column" Property="Loadtime" Title="Loadtime" Width="60px"></RadzenGridColumn>

                        <RadzenGridColumn TItem="MSR1_column" Property="PercentSpeedDifference" Title="Speed" Width="50px"></RadzenGridColumn>
                        <RadzenGridColumn TItem="MSR1_column" Property="ProductionOrder" Title="Order #" Width="60px"></RadzenGridColumn>
                        <RadzenGridColumn TItem="MSR1_column" Property="Material" Title="Material" Width="100px"></RadzenGridColumn>

                        <RadzenGridColumn TItem="MSR1_column" Property="Override" Title="O" Width = "6px"></RadzenGridColumn>

                        <RadzenGridColumn TItem="MSR1_column" Property="StrMiscLabel1" Title="MISC" Width="62px"></RadzenGridColumn>
                        <RadzenGridColumn TItem="MSR1_column" Property="StrMiscLabel2" Title="Loading" Width="60px"></RadzenGridColumn>
                  </Columns>
        </RadzenGrid>
}
</div>
 <button id="TableRefreshBUT" @onclick="OnInitializedAsync" hidden="true"> Refresh </button> 

@code {
    IEnumerable<MSR1_column>? msr1_column;

    protected override async Task OnInitializedAsync()
    {
        msr1_column = await Task.Run(() => productService.ProductList());
    }

    Density Density;

    void RowRender(RowRenderEventArgs<MSR1_column> args)  // controls the font 
    {
        Density = Density.Compact;
        args.Attributes.Add("style", $"font-weight: {("bold")};");
    }

    private static int flash = 0;

    private bool Override(string? Override)
    {
        bool status = false;
        if (Override == null)
        {
            status = true;
        }
        else if (Override.Contains("UNAVAILABLE"))
        {
            status = false;
        }
        else
        {
            try
            {
                int rapvalue = int.Parse(Override);
                if (rapvalue > 99)
                {
                    status = true;
                }
                else
                {
                    status = false;
                }
            }
            catch
            {
                status = true;
            }
        }

        return status;
    }


    void CellRender(CellRenderEventArgs<MSR1_column> col)  // controls the color
    {
        if (col.Column.Property == "MachineID")
        {
            switch (col.Data.MachineMode)
            {
                case "RUNNING":
                    col.Attributes.Add("style", $"font-weight: {("730")};" +
                        $"background-image: linear-gradient(180deg, #E0ffE5 0%, #78ff85 100%);");
                    break;
                case "LOADING": // the operator is loading a part
                    col.Attributes.Add("style", $"font-weight: {("730")};" +
                        $"background-image: linear-gradient(180deg, #E0ffE5 0%, #78ff85 100%);");
                    break;
                case "IDLE":
                    col.Attributes.Add("style", $"font-weight: {("730")};" +
                        $"background-image: linear-gradient(180deg, #fff9E0 0%, #ffff10 100%);");
                    break;
                case "FEED_HOLD":
                    col.Attributes.Add("style", $"font-weight: {("730")};" +
                        $"background-image: linear-gradient(180deg, #fff9E0 0%, #ffff10 100%);");
                    break;
                case "MANUAL":
                    col.Attributes.Add("style", $"font-weight: {("730")};" +
                        $"background-image: linear-gradient(180deg, #E0E4ff 0%, #10EEFF 100%);");
                    break;
                case "OFFLINE":
                    if (col.Data.ProductionMonitorState == "OFFLINE" || col.Data.ProductionMonitorState == "No Job/Op")
                    {
                        col.Attributes.Add("style", $"font-weight: {("730")};" + $"background-image: linear-gradient(180deg, #ffE0E0 0%, #B6B6B6 100%);");
                    }
                    else
                    {
                        col.Attributes.Add("style", $"font-weight: {("730")};" + $"background-image: linear-gradient(180deg, #ffE0E0 0%, #FF4242 100%);");
                    }
                    break;
                default:
                    col.Attributes.Add("style", $"font-weight: {("730")};" + $"background-image: linear-gradient(180deg, #ffE0E0 0%, #FF4242 100%);");
                    break;
            }
        }
        else if (col.Column.Property != "StrMiscLabel1" && col.Column.Property != "StrMiscLabel2" && col.Column.Property != "Material" && col.Column.Property != "ProductionOrder" && col.Column.Property != "Override")
        {
            if (col.Column.Property == "IdealCycleTime" && col.Data.ProductionOrder != "" && col.Data.ProductionOrder != null && col.Data.IdealCycleTime == "00:00:00")
            {
                col.Attributes.Add("style", $"background-color: #f58000");
            }
            else
            {
                if (col.Data.MachineMode != "RUNNING" && col.Data.MachineMode != "LOADING" && col.Data.MachineMode != "OFFLINE")
                {
                    col.Attributes.Add("style", $"background-color: {(col.Data.MachineMode == "MANUAL" ? "#00EEFF" : (col.Data.MachineMode == "OFFLINE" || col.Data.MachineMode == "PGM_STOP" || col.Data.MachineMode == "INTERUPT" ? "#FF4040" : "#ffff00"))};");
                }
                else if (col.Data.MachineMode == "OFFLINE")
                {
                    col.Attributes.Add("style", $"background-color: {((col.Data.ProductionMonitorState == "OFFLINE" || col.Data.ProductionMonitorState == "No Job/Op") ? "#BABABA" : "#FF4040")};");
                }
                else
                {
                    double speeddif = 100;
                    
                    try
                    {
                        speeddif = double.Parse(col.Data.PercentSpeedDifference.Trim('%'));
                    }
                    catch
                    { }
                    
                    if (col.Column.Property == "PercentSpeedDifference")
                    {
                        flash++;
                        if (flash>4000)
                        {
                            flash = 0;
                        }

                        if (speeddif > 105) // more than 5%
                        {
                            if (flash<3500)
                            {
                                col.Attributes.Add("style", $"background-color: #50FF00;");
                            }
                            else
                            {
                                col.Attributes.Add("style", $"background-color: #77ff77;");
                            }
                        }
                        else if (speeddif < 95) // less than -5%
                        {
                            if (flash<3500)
                            {
                                col.Attributes.Add("style", $"background-color: #A0ffAA;");
                            }
                            else
                            {
                                col.Attributes.Add("style", $"background-color: #77ff77;");
                            }
                        }
                        else // ideal
                        {
                            col.Attributes.Add("style", $"background-color: #77ff77;");
                        }
                    }
                    else
                    {
                        if (speeddif > 105) // more than 5%
                        {
                            col.Attributes.Add("style", $"background-color: #50FF00;");
                        }
                        else if (speeddif < 95) // less than -5%
                        {
                            col.Attributes.Add("style", $"background-color: #A0ffAA;");
                        }
                        else // ideal
                        {
                            col.Attributes.Add("style", $"background-color: #77ff77;");
                        }
                    }
       
                }
            }
        }
        else if(col.Column.Property == "StrMiscLabel1")
        {
            bool rap1 = Override(col.Data.Rapid);
            bool rap2 = Override(col.Data.Rapid2);
            bool feed1 = Override(col.Data.Feed);
            bool feed2 = Override(col.Data.Feed2);
            bool spind1 = Override(col.Data.Spindle);
            bool spind2 = Override(col.Data.Spindle2);
            bool gantry = Override(col.Data.Gantry);

            if (rap1 && rap2 && feed1 && feed2 && spind1 && spind2 && gantry)
            {
                col.Attributes.Add("style", $"background-color: {(col.Data.StrMiscLabel1 == "Overrides" ? "#77ff77" : "#F0FFFA")};");
            }
            else
            {
                col.Attributes.Add("style", $"background-color: {(col.Data.StrMiscLabel1 == "Overrides" ? "#ff2020" : "#F0FFFA")};");
            }

        }
        else if (col.Column.Property == "StrMiscLabel2")
        {
            if (col.Data.StrMiscLabel2 == "Gantry Override")
            {
                if (col.Data.Gantry == "100" || col.Data.Gantry == null)
                {
                    col.Attributes.Add("style", $"background-color: #77ff77");
                }
                else
                {
                    col.Attributes.Add("style", $"background-color: #ff2020");
                }
            }
            else if (col.Data.StrMiscLabel2 != "" && col.Data.StrMiscLabel2 != "" && col.Data.ProductionOrder != null)
            {
                if (col.Data.IdealLoadTime == "00:00:00" && col.Data.ProductionOrder != "" && col.Data.MachineID != "2271 DOOSAN")
                {
                    col.Attributes.Add("style", $"background-color: #f58000");
                }
            }

        }
        else if (col.Column.Property == "Override")
        {
            col.Attributes.Add("style", $"background-color: {(col.Data.Override != false ? "#FF4040" : "#7777ff")};");
        }
    }

     void HeaderFooterCellRender(DataGridCellRenderEventArgs<MSR1_column> args)
     {
        if (args.Column.Property == "MachineID")
        {
            args.Attributes.Add("colspan", 2);
        }
     }
    
}